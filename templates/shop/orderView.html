{% extends 'shop/basic.html' %}
{% block title %} Orders - Royal Shetkari {% endblock %}

{% load static %}
{% block css %}
<link href="{% static 'template/all_template.css' %}" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
    /* Modern Card-based Design */
    .main-container {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px 0;
    }
    
    .content-wrapper {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        padding: 30px;
        margin-bottom: 30px;
    }
    
    /* Enhanced Table Design */
    .table-container {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .table {
        margin-bottom: 0;
        font-size: 14px;
        border-collapse: collapse;
    }
    
    .table thead th {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        color: white;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 18px 15px;
        border: none;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .table tbody td {
        padding: 15px;
        vertical-align: middle;
        border-bottom: 1px solid #e0e0e0;
    }
    
    .table tbody tr {
        transition: all 0.3s ease;
    }
    
    .table tbody tr:hover {
        background-color: #f8f9fa;
    }
    
    .table-striped tbody tr:nth-of-type(odd) {
        background-color: rgba(0,123,255,0.02);
    }

    /* PRINT SPECIFIC STYLES */
    @media print {
        /* Reset all styles for printing */
        body * {
            visibility: hidden;
        }
        
        /* Only show the table container and its contents */
        .table-container,
        .table-container * {
            visibility: visible;
        }
        
        /* Position the table at the top of the page */
        .table-container {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            margin: 0;
            padding: 0;
            box-shadow: none;
            border-radius: 0;
            background: white;
        }
        
        /* Table styling for print */
        .table {
            width: 100% !important;
            font-size: 12px !important;
            border-collapse: collapse !important;
        }
        
        .table thead th {
            background: #f0f0f0 !important;
            color: black !important;
            border: 1px solid #000 !important;
            padding: 8px !important;
            font-weight: bold !important;
        }
        
        .table tbody td {
            border: 1px solid #000 !important;
            padding: 6px !important;
            color: black !important;
            background: white !important;
        }
        
        .table tbody tr {
            page-break-inside: avoid;
        }
        
        /* Hide non-essential elements */
        .btn, .action-btn, .eye-button, .badge, .payment-badge i {
            display: none !important;
        }
        
        /* Make payment badges readable */
        .payment-badge {
            background: white !important;
            color: black !important;
            border: 1px solid #000 !important;
            padding: 2px 5px !important;
        }
        
        /* Ensure amounts are clearly visible */
        .amount {
            font-weight: bold !important;
            color: black !important;
        }
        
        /* Page setup */
        @page {
            size: A4 landscape;
            margin: 0.5cm;
        }
        
        /* Print header */
        .table-container::before {
            content: "ROYAL SHETKARI - ORDER MANAGEMENT REPORT";
            display: block;
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid #000;
        }
        
        /* Print footer */
        .table-container::after {
            content: "Printed on: " attr(data-print-date);
            display: block;
            text-align: right;
            font-size: 10px;
            margin-top: 10px;
            font-style: italic;
        }
    }
</style>
<style>
    @media (min-width: 1200px) {
    .container {
        max-width: 1940px;
    }
}
@media (min-width: 576px) {
    .container {
        max-width: 100%;
    }
}
    /* Modern Card-based Design */
    .main-container {
        background: linear-gradient(135deg,rgb(0, 0, 0) 0%,rgb(0, 0, 0) 100%);
        min-height: 100vh;
        padding: 20px 0;
    }
    
    .content-wrapper {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        padding: 30px;
        margin-bottom: 30px;
    }
    
    .page-header {
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #e9ecef;
    }
    
    .page-title {
        font-size: 2.5rem;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }
    
    .page-subtitle {
        color: #6c757d;
        font-size: 1.1rem;
        font-weight: 400;
    }
    
    /* Enhanced Filter Section */
    .filter-section {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }
    
    .filter-title {
        color: #495057;
        font-weight: 600;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .form-control {
        border-radius: 10px;
        border: 0px solid #e9ecef;
        padding: 5px 15px;
        font-size: 14px;
        transition: all 0.3s ease;
    }
    
    .form-control:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        transform: translateY(-2px);
    }
    
    .btn {
        border-radius: 10px;
        padding: 12px 20px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: all 0.3s ease;
        border: none;
    }
    
    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    }
    
    .btn-secondary {
        background: linear-gradient(135deg, #6c757d 0%, #545b62 100%);
    }
    
    .btn-info {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
    }
    
    .btn-warning {
        background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
        color: #000;
    }
    
    .btn-success {
        background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
    }
    
    /* Enhanced Table Design */
    .table-container {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .table {
        margin-bottom: 0;
        font-size: 14px;
    }
    
    .table thead th {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        color: white;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 18px 15px;
        border: none;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .table tbody td {
        padding: 15px;
        vertical-align: middle;
        border-bottom: 1px solid #f8f9fa;
    }
    
    .table tbody tr {
        transition: all 0.3s ease;
    }
    
    .table tbody tr:hover {
        background-color: #f8f9fa;
        transform: scale(1.01);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .table-striped tbody tr:nth-of-type(odd) {
        background-color: rgba(0,123,255,0.02);
    }
    
    /* Payment Method Badges */
    .payment-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 8px 12px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        min-width: 70px;
        gap: 5px;
    }
    
    .payment-cash {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
    }
    
    .payment-card {
        background: linear-gradient(135deg, #ffc107 0%, #ff8c00 100%);
        color: #000;
    }
    
    .payment-online {
        background: linear-gradient(135deg, #007bff 0%, #6610f2 100%);
        color: white;
    }
    
    .payment-other {
        background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
        color: white;
    }
    
    /* Order ID Styling */
    .order-id {
        background: #f8f9fa;
        padding: 8px 12px;
        border-radius: 8px;
        font-family: 'Courier New', monospace;
        font-weight: 600;
        color: #495057;
        border: 2px solid #e9ecef;
    }
    
    /* Amount Styling */
    .amount {
        font-size: 1.1rem;
        font-weight: 700;
        color: #28a745;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }
    
    /* Comments Section */
    .comment-text {
        max-width: 200px;
        word-wrap: break-word;
    }
    
    .eye-button {
        color: #007bff;
        text-decoration: none;
        font-size: 16px;
        margin-left: 8px;
        transition: all 0.3s ease;
    }
    
    .eye-button:hover {
        color: #0056b3;
        transform: scale(1.2);
    }
    
    /* Action Buttons */
    .action-btn {
        padding: 8px 15px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        transition: all 0.3s ease;
        border: none;
    }
    
    .action-btn:hover {
        text-decoration: none;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    /* Summary Cards */
    .summary-section {
        margin-top: 40px;
    }
    
    .summary-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        overflow: hidden;
        transition: all 0.3s ease;
    }
    
    .summary-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    }
    
    .summary-card .card-header {
        background: linear-gradient(135deg, #007bff 0%, #6610f2 100%);
        color: white;
        padding: 20px;
        border: none;
    }
    
    .summary-card .card-body {
        padding: 25px;
    }
    
    .payment-summary-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid #f8f9fa;
        transition: all 0.3s ease;
    }
    
    .payment-summary-item:hover {
        background-color: #f8f9fa;
        padding-left: 10px;
    }
    
    .payment-summary-item:last-child {
        border-bottom: none;
    }
    
    .total-card {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        text-align: center;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(40, 167, 69, 0.3);
    }
    
    .total-amount {
        font-size: 2.5rem;
        font-weight: 700;
        margin: 15px 0;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }
    
    /* Thermal Printer Styles */
    .thermal-receipt {
        display: none;
    }
    
    @media print {
        * {
            visibility: hidden;
        }
        
        .thermal-receipt, .thermal-receipt * {
            visibility: visible;
        }
        
        .thermal-receipt {
            position: absolute;
            left: 0;
            top: 0;
            width: 80mm;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            color: #000;
            background: white;
            margin: 0;
            padding: 2mm;
        }
        
        .receipt-header {
            text-align: center;
            margin-bottom: 4mm;
            padding-bottom: 3mm;
            border-bottom: 2px dashed #000;
        }
        
        .receipt-title {
            font-size: 16px;
            font-weight: bold;
            margin: 2mm 0;
            text-decoration: underline;
        }
        
        .receipt-subtitle {
            font-size: 14px;
            font-weight: bold;
            margin: 1mm 0;
        }
        
        .receipt-contact {
            font-size: 10px;
            margin: 0.5mm 0;
            line-height: 1.2;
        }
        
        .receipt-divider {
            text-align: center;
            margin: 3mm 0;
            font-size: 12px;
            font-weight: bold;
        }
        
        .receipt-items {
            margin: 3mm 0;
        }
        
        .receipt-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 2mm 0;
            border-bottom: 1px dotted #666;
            font-size: 11px;
            line-height: 1.3;
        }
        
        .receipt-item:last-child {
            border-bottom: 2px solid #000;
            margin-bottom: 2mm;
        }
        
        .receipt-item-name {
            flex: 1;
            padding-right: 3mm;
            font-weight: 500;
        }
        
        .receipt-item-qty {
            min-width: 15mm;
            text-align: center;
            font-weight: bold;
        }
        
        .receipt-item-price {
            min-width: 20mm;
            text-align: right;
            font-weight: bold;
        }
        
        .receipt-total {
            margin-top: 3mm;
            padding: 3mm 0;
            border-top: 3px double #000;
            border-bottom: 3px double #000;
            text-align: center;
            font-weight: bold;
            font-size: 16px;
        }
        
        .receipt-footer {
            text-align: center;
            margin-top: 4mm;
            padding-top: 3mm;
            border-top: 2px dashed #000;
            font-size: 10px;
            line-height: 1.4;
        }
        
        .receipt-thank-you {
            font-size: 12px;
            font-weight: bold;
            margin: 2mm 0;
        }
        
        @page {
            size: 80mm auto;
            margin: 2mm;
        }
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
        .content-wrapper {
            margin: 10px;
            padding: 20px;
        }
        
        .page-title {
            font-size: 2rem;
        }
        
        .filter-section {
            padding: 20px;
        }
        
        .table-responsive {
            border-radius: 10px;
        }
        
        .btn {
            padding: 10px 15px;
            font-size: 12px;
        }
    }
    
    /* Loading Animation */
    .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block body %}
{% if user.is_authenticated %}
<div class="main-container">
    <div class="container">
        <div class="content-wrapper">
            <!-- Page Header -->
            <div class="page-header">
                <h1 class="page-title">
                    <i class="fas fa-receipt"></i> Order Management
                </h1>
                <p class="page-subtitle">Track and manage all customer orders efficiently</p>
            </div>

            <!-- Filter Section -->
            {% if user.last_name == "admin" %}
            <div class="filter-section">
                <h4 class="filter-title">
                    <i class="fas fa-filter"></i> Advanced Filters
                </h4>
                <form id="filterForm" method="post" action="">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Start Date</label>
                            <input type="date" id="startDate" name="start_date" class="form-control">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">End Date</label>
                            <input type="date" id="endDate" name="end_date" class="form-control">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Payment Method</label>
                            <select name="payment_method" class="form-control">
                                <option value="">All Payment Methods</option>
                                <option value="Cash">üíµ Cash</option>
                                <option value="Card">üí≥ Card</option>
                                <option value="Online">üåê Online</option>
                                <option value="Other">üì± Other</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary flex-fill">
                                    <i class="fas fa-search"></i> Filter
                                </button>
                                <a href="" class="btn btn-secondary">
                                    <i class="fas fa-refresh"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <a href="#" onclick="window.print()" class="btn btn-info">
                                <i class="fas fa-print"></i> Print All
                            </a>
                        </div>
                    </div>
                </form>
            </div>
            {% else %}
            <div class="alert alert-warning">
                <i class="fas fa-lock"></i> Admin access required for advanced filtering
            </div>
            {% endif %}

            <!-- Orders Table -->
            <div class="table-container">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th><i class="fas fa-hashtag"></i> #</th>
                                <th><i class="fas fa-barcode"></i> Order ID</th>
                                <th><i class="fas fa-calendar"></i> Date & Time</th>
                                <th><i class="fas fa-credit-card"></i> Payment</th>
                                <th><i class="fas fa-comment"></i> Remarks</th>
                                <th><i class="fas fa-list"></i> Items</th>
                                <th><i class="fas fa-edit"></i> Update</th>
                                <th><i class="fas fa-rupee-sign"></i> Amount</th>
                                <th><i class="fas fa-calculator"></i> Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for i in orderHistory reversed %}
                            <tr>
                                <td><span class="badge badge-primary">{{ forloop.counter }}</span></td>
                                <td><code class="order-id">{{ i.order_id }}</code></td>
                                <td>
                                    <div>{{ i.timestamp|date:"d M Y" }}</div>
                                    <small class="text-muted">{{ i.timestamp|date:"H:i" }}</small>
                                </td>
                                <td>
                                    <span class="payment-badge payment-{{ i.payment_method|lower }}">
                                        {% if i.payment_method == "Cash" %}
                                            <i class="fas fa-money-bill"></i>
                                        {% elif i.payment_method == "Card" %}
                                            <i class="fas fa-credit-card"></i>
                                        {% elif i.payment_method == "Online" %}
                                            <i class="fas fa-globe"></i>
                                        {% else %}
                                            <i class="fas fa-mobile-alt"></i>
                                        {% endif %}
                                        {{ i.payment_method }}
                                    </span>
                                </td>
                                <td class="comment-text">
                                    {% if i.payment_comments %}
                                        {% if i.payment_comments|length > 25 %}
                                            <span id="shortComment{{ i.order_id }}">
                                                {{ i.payment_comments|slice:":20" }}...
                                            </span>
                                            <a href="#" class="eye-button" onclick="toggleComments('{{ i.order_id }}')" title="View full comment">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <span id="fullComment{{ i.order_id }}" style="display:none;">
                                                {{ i.payment_comments }}
                                            </span>
                                        {% else %}
                                            {{ i.payment_comments }}
                                        {% endif %}
                                    {% else %}
                                        <em class="text-muted">No remarks</em>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="#" id="click{{ i.order_id }}" class="action-btn btn-outline-primary" title="View & Print Receipt">
                                        <i class="fas fa-receipt"></i> View & Print
                                    </a>
                                </td>
                                <td>
                                    <a href="{% url 'shop:update_order' i.order_id %}" class="action-btn btn-warning">
                                        <i class="fas fa-check"></i> Order Complete
                                    </a>
                                </td>
                                <td><span class="amount">‚Çπ{{ i.amount }}</span></td>
                                <td><span class="amount">‚Çπ{{ i.amount }}</span></td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="9" class="text-center">
                                    <div class="py-5">
                                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                        <h5 class="text-muted">No orders found</h5>
                                        <p class="text-muted">Orders will appear here once customers place them</p>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr class="bg-light">
                                <td colspan="8" class="text-right font-weight-bold">Total Revenue:</td>
                                <td class="font-weight-bold">‚Çπ{{ total_amount }}</td>
                            </tr>
                            {% if user.last_name == "admin" %}
                            <tr class="bg-light">
                                <td colspan="8" class="text-right font-weight-bold">Cash Payments:</td>
                                <td class="font-weight-bold">‚Çπ{{ cash_total }}</td>
                            </tr>
                            <tr class="bg-light">
                                <td colspan="8" class="text-right font-weight-bold">Card Payments:</td>
                                <td class="font-weight-bold">‚Çπ{{ card_total }}</td>
                            </tr>
                            <tr class="bg-light">
                                <td colspan="8" class="text-right font-weight-bold">Online Payments:</td>
                                <td class="font-weight-bold">‚Çπ{{ online_total }}</td>
                            </tr>
                            <tr class="bg-light">
                                <td colspan="8" class="text-right font-weight-bold">Other Payments:</td>
                                <td class="font-weight-bold">‚Çπ{{ other_total }}</td>
                            </tr>
                            {% endif %}
                        </tfoot>
                    </table>
                </div>
            </div>

            <!-- Summary Section -->
            {% if user.last_name == 'admin' %}
            <div class="summary-section">
                <div class="row">
                    <div class="col-lg-8 mb-4">
                        <div class="summary-card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-chart-pie"></i> Payment Method Breakdown
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="payment-summary-item">
                                    <div>
                                        <i class="fas fa-money-bill text-success"></i>
                                        <strong>Cash Payments</strong>
                                        <small class="text-muted">({{ cash_percentage|floatformat:2 }}% of total)</small>
                                    </div>
                                    <span class="badge badge-success badge-pill">‚Çπ{{ cash_total }}</span>
                                </div>
                                <div class="payment-summary-item">
                                    <div>
                                        <i class="fas fa-credit-card text-warning"></i>
                                        <strong>Card Payments</strong>
                                        <small class="text-muted">({{ card_percentage|floatformat:2 }}% of total)</small>
                                    </div>
                                    <span class="badge badge-warning badge-pill">‚Çπ{{ card_total }}</span>
                                </div>
                                <div class="payment-summary-item">
                                    <div>
                                        <i class="fas fa-globe text-primary"></i>
                                        <strong>Online Payments</strong>
                                        <small class="text-muted">({{ online_percentage|floatformat:2 }}% of total)</small>
                                    </div>
                                    <span class="badge badge-primary badge-pill">‚Çπ{{ online_total }}</span>
                                </div>
                                <div class="payment-summary-item">
                                    <div>
                                        <i class="fas fa-mobile-alt text-danger"></i>
                                        <strong>Other Payments</strong>
                                        <small class="text-muted">({{ other_percentage|floatformat:2 }}% of total)</small>
                                    </div>
                                    <span class="badge badge-danger badge-pill">‚Çπ{{ other_total }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 mb-4">
                        <div class="total-card">
                            <i class="fas fa-coins fa-3x mb-3"></i>
                            <h5>Total Revenue</h5>
                            <div class="total-amount">‚Çπ{{ total_amount }}</div>
                            <small>Selected Period</small>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="total-card">
                <i class="fas fa-coins fa-3x mb-3"></i>
                <h5>Your Total Orders</h5>
                <div class="total-amount">‚Çπ{{ total_amount }}</div>
                <small>Selected Period Total</small>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Hidden div for thermal receipt -->
<div id="thermalReceipt" class="thermal-receipt"></div>

{% else %}
<div class="main-container">
    <div class="container">
        <div class="content-wrapper text-center">
            <i class="fas fa-lock fa-4x text-primary mb-4"></i>
            <h2 class="text-primary">Authentication Required</h2>
            <p class="lead">Please log in to access order management</p>
            <a href="#" class="btn btn-primary" data-toggle="modal" data-target="#loginModal">
                <i class="fas fa-sign-in-alt"></i> Login Now
            </a>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block js %}
<script>
    // Toggle comment visibility
    function toggleComments(orderId) {
        const shortComment = document.getElementById(`shortComment${orderId}`);
        const fullComment = document.getElementById(`fullComment${orderId}`);
        const eyeButton = shortComment.nextElementSibling;
        
        if (fullComment.style.display === "none" || fullComment.style.display === "") {
            shortComment.style.display = "none";
            fullComment.style.display = "inline";
            eyeButton.innerHTML = '<i class="fas fa-eye-slash"></i>';
            eyeButton.title = "Hide full comment";
        } else {
            shortComment.style.display = "inline";
            fullComment.style.display = "none";
            eyeButton.innerHTML = '<i class="fas fa-eye"></i>';
            eyeButton.title = "View full comment";
        }
    }

    // Enhanced receipt generation with better formatting
    $(document).ready(function() {
        {% for i in orderHistory %}
        $('#click{{i.order_id}}').click(function() {
            // Show loading
            $(this).html('<div class="loading"></div> Processing...');
            
            setTimeout(() => {
                // Parse order items
                let mydata = "{{i.items_json}}";
                mydata = mydata.replace(/&quot;/g, '"');
                let obj = JSON.parse(mydata);
                let totalAmount = 0;
                let itemCount = Object.keys(obj).length;
                
                // Build enhanced thermal receipt HTML
                let receiptHTML = `
                <div class="receipt-header">
                    <div class="receipt-title">‡§∞‡•â‡§Ø‡§≤ ‡§∂‡•á‡§§‡§ï‡§∞‡•Ä</div>
                    <div class="receipt-subtitle">ROYAL SHETKARI</div>
                    <div class="receipt-contact">‡§™‡•ç‡§∞‡•ã‡§™‡•ç‡§∞‡§æ. ‡§Ö‡§≠‡§ø‡§ú‡•Ä‡§§ ‡§ï‡•ã‡§≥‡§µ‡§≤‡•á</div>
                    <div class="receipt-contact">‡§Æ‡•ã. ‡•Ø‡•©‡•≠‡•¶‡•≠‡•¶‡•®‡•´‡•Æ‡•¨</div>
                    <div class="receipt-contact">‡§§‡•á‡§ú‡§∏ ‡§Ö‚Äç‡•Ö‡§ó‡•ç‡§∞‡•ã ‡§∂‡•á‡§ú‡§æ‡§∞‡•Ä, ‡§™‡§Ç‡§¢‡§∞‡§™‡•Ç‡§∞-‡§™‡•Å‡§£‡•á ‡§π‡§æ‡§Ø‡§µ‡•á</div>
                    <div class="receipt-contact">‡§≠‡§Ç‡§°‡•Ä‡§∂‡•á‡§ó‡§æ‡§µ, ‡§§‡§æ. ‡§™‡§Ç‡§¢‡§∞‡§™‡•Ç‡§∞, ‡§ú‡§ø. ‡§∏‡•ã‡§≤‡§æ‡§™‡•Ç‡§∞</div>
                </div>
                
                <div class="receipt-divider">‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê</div>
                
                <div class="receipt-contact" style="text-align: center; margin: 2mm 0;">
                    <strong>Order ID: {{i.order_id}}</strong><br>
                    Date: {{i.timestamp|date:"d/m/Y H:i"}}<br>
                    Payment: {{i.payment_method}}
                </div>
                
                <div class="receipt-divider">‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê</div>
                
                <div class="receipt-items">
                    <div style="display: flex; justify-content: space-between; font-weight: bold; border-bottom: 2px solid #000; padding-bottom: 1mm; margin-bottom: 2mm;">
                        <span>ITEM</span>
                        <span>QTY</span>
                        <span>PRICE</span>
                    </div>`;
                
                // Add items with better formatting
                for (let item in obj) {
                    let name = obj[item][1];
                    let qty = obj[item][0];
                    let itemPrice = obj[item][2];
                    let sumPrice = qty * itemPrice;
                    totalAmount += sumPrice;
                    
                    // Better name truncation with word boundary
                    let shortName = name.length > 18 ? 
                        name.substring(0, 15).trim() + '...' : name;
                    
                    receiptHTML += `
                        <div class="receipt-item">
                            <div class="receipt-item-name">${shortName}</div>
                            <div class="receipt-item-qty">${qty}</div>
                            <div class="receipt-item-price">‚Çπ${sumPrice}</div>
                        </div>`;
                }
                
                receiptHTML += `
                </div>
                
                <div class="receipt-total">
                    TOTAL: ‚Çπ${totalAmount}/-
                </div>
                
                <div class="receipt-footer">
                    <div class="receipt-thank-you">‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶! Thank You!</div>
                    <div>Visit Again Soon</div>
                    <div>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê</div>
                    <div style="font-size: 8px; margin-top: 2mm;">
                        Powered by Prasad Yalmar POS
                    </div>
                </div>`;
                
                // Set the receipt content
                $('#thermalReceipt').html(receiptHTML);
                
                // Calculate optimal window size
                let baseHeight = 400;
                let itemHeight = 30;
                let calculatedHeight = baseHeight + (itemCount * itemHeight);
                let finalHeight = Math.max(calculatedHeight, 500);
                
                // Create enhanced popup window
                let popup = window.open('', 'ThermalReceipt', 
                    `width=320,height=${finalHeight},scrollbars=no,resizable=yes,menubar=no,toolbar=no,location=no,status=no`);
                
                popup.document.write(`
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Receipt - Order {{i.order_id}}</title>
                    <style>
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        
                        body {
                            font-family: 'Courier New', monospace;
                            background: #f8f9fa;
                            padding: 10px;
                        }
                        
                        .receipt-container {
                            width: 80mm;
                            margin: 0 auto;
                            background: white;
                            padding: 3mm;
                            border: 2px solid #ddd;
                            border-radius: 5px;
                            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                        }
                        
                        .receipt-header {
                            text-align: center;
                            margin-bottom: 4mm;
                            padding-bottom: 3mm;
                            border-bottom: 2px dashed #000;
                        }
                        
                        .receipt-title {
                            font-size: 18px;
                            font-weight: bold;
                            margin: 2mm 0;
                            text-decoration: underline;
                            color: #2c3e50;
                        }
                        
                        .receipt-subtitle {
                            font-size: 14px;
                            font-weight: bold;
                            margin: 1mm 0;
                            color: #34495e;
                        }
                        
                        .receipt-contact {
                            font-size: 10px;
                            margin: 0.5mm 0;
                            line-height: 1.3;
                            color: #555;
                        }
                        
                        .receipt-divider {
                            text-align: center;
                            margin: 3mm 0;
                            font-size: 10px;
                            font-weight: bold;
                            color: #666;
                        }
                        
                        .receipt-items {
                            margin: 3mm 0;
                        }
                        
                        .receipt-item {
                            display: flex;
                            justify-content: space-between;
                            align-items: flex-start;
                            padding: 2mm 0;
                            border-bottom: 1px dotted #999;
                            font-size: 11px;
                            line-height: 1.4;
                        }
                        
                        .receipt-item:last-child {
                            border-bottom: 2px solid #000;
                            margin-bottom: 2mm;
                        }
                        
                        .receipt-item-name {
                            flex: 1;
                            padding-right: 3mm;
                            font-weight: 500;
                            color: #2c3e50;
                        }
                        
                        .receipt-item-qty {
                            min-width: 15mm;
                            text-align: center;
                            font-weight: bold;
                            color: #e74c3c;
                        }
                        
                        .receipt-item-price {
                            min-width: 20mm;
                            text-align: right;
                            font-weight: bold;
                            color: #27ae60;
                        }
                        
                        .receipt-total {
                            margin-top: 3mm;
                            padding: 4mm 0;
                            border-top: 3px double #000;
                            border-bottom: 3px double #000;
                            text-align: center;
                            font-weight: bold;
                            font-size: 18px;
                            background: #f8f9fa;
                            color: #2c3e50;
                        }
                        
                        .receipt-footer {
                            text-align: center;
                            margin-top: 4mm;
                            padding-top: 3mm;
                            border-top: 2px dashed #000;
                            font-size: 10px;
                            line-height: 1.5;
                            color: #555;
                        }
                        
                        .receipt-thank-you {
                            font-size: 12px;
                            font-weight: bold;
                            margin: 2mm 0;
                            color: #e74c3c;
                        }
                        
                        .control-panel {
                            text-align: center;
                            margin-bottom: 15px;
                            padding: 10px;
                            background: white;
                            border-radius: 5px;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        }
                        
                        .control-btn {
                            background: linear-gradient(135deg, #3498db, #2980b9);
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            margin: 0 5px;
                            border-radius: 5px;
                            cursor: pointer;
                            font-size: 12px;
                            font-weight: bold;
                            transition: all 0.3s ease;
                        }
                        
                        .control-btn:hover {
                            transform: translateY(-2px);
                            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                        }
                        
                        .control-btn.close {
                            background: linear-gradient(135deg, #e74c3c, #c0392b);
                        }
                        
                        @media print {
                            body {
                                background: white;
                                padding: 0;
                            }
                            
                            .control-panel {
                                display: none !important;
                            }
                            
                            .receipt-container {
                                width: 80mm;
                                margin: 0;
                                padding: 2mm;
                                border: none;
                                border-radius: 0;
                                box-shadow: none;
                            }
                            
                            @page {
                                size: 80mm auto;
                                margin: 2mm;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="control-panel">
                       <button class="control-btn" onclick="window.print(); setTimeout(() => window.close(), 2000);">
                        üñ®Ô∏è Print Receipt
                    </button>
                        <button class="control-btn close" onclick="window.close()">
                            ‚ùå Close
                        </button>
                    </div>
                    <div class="receipt-container">
                        ${receiptHTML}
                    </div>
                </body>
                </html>`);
                
                popup.document.close();
                popup.focus();
                
                // Reset button text
                $(this).html('<i class="fas fa-receipt"></i> View & Print');
            }, 1000);
        });
        {% endfor %}
        
        // Auto-refresh every 30 seconds for new orders
        setInterval(function() {
            if (document.hidden === false) {
                location.reload();
            }
        }, 30000);
        
        // Add search functionality
        function addSearchFunctionality() {
            const searchInput = $('<input>', {
                type: 'text',
                class: 'form-control mb-3',
                placeholder: 'üîç Search orders by ID, payment method, or remarks...',
                id: 'orderSearch'
            });
            
            $('.table-container').prepend(searchInput);
            
            $('#orderSearch').on('keyup', function() {
                const value = $(this).val().toLowerCase();
                $('table tbody tr').filter(function() {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
                });
            });
        }
        
        // Initialize search if admin
        {% if user.last_name == "admin" %}
        addSearchFunctionality();
        {% endif %}
        
        // Add keyboard shortcuts
        $(document).keydown(function(e) {
            // Ctrl+P for print
            if (e.ctrlKey && e.keyCode === 80) {
                e.preventDefault();
                window.print();
            }
            // Ctrl+R for refresh
            if (e.ctrlKey && e.keyCode === 82) {
                e.preventDefault();
                location.reload();
            }
        });
        
        // Add tooltips
        $('[title]').tooltip();
        
        // Smooth scrolling for better UX
        $('html').css('scroll-behavior', 'smooth');
    });
</script>
<script>
    // Print function
    function printTable() {
        window.print();
    }
    
    // Add print button if needed
    $(document).ready(function() {
        $('.table-container').prepend(
            '<button onclick="printTable()" class="btn btn-primary mb-3">' +
            '<i class="fas fa-print"></i> Print Orders' +
            '</button>'
        );
    });
</script>
<!-- Footer -->
<div class="footer bg-dark text-light mt-5" style="width: 100%; position: relative; bottom: 0; left: 0;">
    <div class="container">
        <div class="row py-4">
            <div class="col-md-6">
                <h5><i class="fas fa-store"></i> Royal Shetkari</h5>
                <p class="mb-0">Advanced Order Management System</p>
            </div>
            <div class="col-md-6 text-md-right">
                <p class="mb-0">
                    <i class="fas fa-copyright"></i> 2024 Designed by 
                    <a href="https://mipashyayalmar.github.io/-Profile-data/" target="_blank" rel="noopener noreferrer" class="text-light">
                        <strong>@Mipashya</strong>
                    </a>
                </p>
                <small class="text-muted">Version 2.0 - Enhanced Edition</small>
            </div>
        </div>
    </div>
</div>
{% endblock %}